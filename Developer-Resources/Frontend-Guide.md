Welcome to the Front-End Guide for Open Library, a primer for making front-end changes to the openlibrary.org website.

## How does url routing work?

[Lookup the url pattern here](https://github.com/internetarchive/openlibrary/wiki/Endpoints#list-of-all-routes) or via https://dev.openlibrary.org/developers/routes to find out which view class is responsible for generating the template with which you wish to work. Some routes may pass through Open Library (to Infogami) and actually be handled generically by Infogami. This is true for routes like `/books/OL..M/:title` whose route patterns you can see registered at the bottom of `openlibrary/core/models.py`. You may note, most of the url routing is handled within [openlibrary/plugins](https://github.com/internetarchive/openlibrary/tree/master/openlibrary/plugins). Each view class specifies whether it returns json or if it returns a template. If it returns a template, the first argument should be the template's path (relative to the `templates/` directory) where it lives. The values following the template name are variables passed into the template (that the template will have access to). 

## Working with JavaScript

Open Library uses jQuery. Except `jquery` and `jquery-ui`, other third-party JavaScript libraries are combined and included as `vendor.js`. All the custom JavaScripts are combined and includes as `all.js`.

Most of the heavy application lifting is done by a file in `openlibrary/openlibrary/plugins/openlibrary/js/ol.js`

### vendor.js and third party libraries

All third-party JavaScripts are added in the `vendor/js`_ directory in the  repository and `static/build/vendor.js` is generated by combining these  JavaScripts. The files included in `static/build/vendor.js` are specified in a shell script `static/js/vendor.jsh`.

To include a new third-party library:

* Add that library in [vendor/js](http://github.com/internetarchive/openlibrary/tree/master/vendor/js) in the repository
* Add an entry in [static/js/vendor.jsh](http://github.com/internetarchive/openlibrary/tree/master/static/upstream/js/vendor.jsh)
* Generate `vendor.js` by running `make`:
```        
$ make js
```
* Commit vendor.jsh and the library added to the repository

### all.js and custom JavaScripts

All the custom JavaScript files are put in the repo at `openlibrary/plugins/openlibrary/js`. All these JavaScript files are combined to generate `build/js/all.js`.

The order in which these files are included is determined by the sort order of the names. In general, it is a bad idea to depend on the order of files loaded.

If you make any changes to any of the JavaScript files, run `make js` to regenerate `build/js/all.js`.

### Working in Docker

Refer to: https://github.com/internetarchive/openlibrary/blob/master/docker/README.md#code-updates

While running the oldev container, gunicorn is configured to auto-reload modified files. To see the effects of your changes in the running container, the following apply:

Editing python files or web templates => simply save the file, gunicorn will auto-reload it.
Working on frontend css or js => you must run docker-compose exec web make css js. This will re-generate the assets in the persistent ol-build volume mount, so the latest changes will be available between stopping / starting and removing web containers. Note, if you want to view the generated output you will need to attach to the container (docker-compose exec web bash) to examine the files in the volume, not in your local dir.
Adding or changing core dependencies => you will most likely need to rebuild both olbase and oldev images. This shouldn't happen too frequently. If you are making this sort of change, you will know exactly what you are doing

## Working with CSS

All stylesheets are in `static/css`. They are combined to generate `build/css/all.css`, which is included in all the web pages.

It's a good idea to break CSS into multiple logical files, instead of putting it in one monolithic file.

If you make changes to any CSS, run `make css` to regenerate `build/css/all.css`.

### Beware of bundle sizes

When adding CSS content, while testing you may face an error such as this for example:

```
 FAIL static/build/page-plain.css: 18.81KB > maxSize 18.8KB (gzip)
```
This is telling you that your changes have increased the amount of CSS loaded, more than the required amount. This can lead to performance degradation so note that it should be avoided wherever possible (or be well justified!).

These problems are especially a concern for [CSS files on the critical path](https://www.smashingmagazine.com/2015/08/understanding-critical-css/). Always consider placing styles in an JavaScript entrypoint file e.g. `<file_name>--js.less` and load it inside `static/css/js-all.less` via `@import`. This CSS will only get loaded via JavaScript and has a much higher bundlesize threshold.

## Working with HTML

Open Library uses templetor syntax in our HTML. See its documentation first: http://webpy.org/docs/0.3/templetor

Here are some quick/useful snippets:
```html
$# Rendering sanitized text vs. HTML; replace `$` with `$:` in any of the following statements
$cond(True, 'a < 3', '')
$# Renders as:
a &lt; 3
$:cond(True, '<li>x</li>', '')
$# Renders as:
<li>x</li>

$# Short if/else statement
$ show_foo = true
<span>Hello, $cond(show_foo, 'foo', 'bar')!</span>
$# Renders as:
<span>Hello, foo!</span>

$# Add commas to an integer
$commify(1000)
$# Renders as:
1,000

$# Rendering other macros/templates
$:macros.EditButtons(comment="")
$:render_template("lib/pagination", pagecount, pageindex, "/admin/loans?page=%(page)s")
```

### Internationalization (i18n)
Any text that will be visible to the user should be internationalized. Use the special `$_` function.
See the webpy templetor i18n docs as well: http://webpy.org/cookbook/i18n_support_in_template_file

Example:
```html
$# Simple string i18n
<a title="$('Add this book to your Want to Read shelf')">$_('Want to Read')</a>

$# Pluralization: rendering pluralized text
$ungettext("There is one person waiting for this book.", "There are %(n)s people waiting for this book.", wlsize, n=wlsize)
```

In the translation file, this would look like:

```po
#: borrow.html:114
#, python-format
msgid "There is one person waiting for this book."
msgid_plural "There are %(n)s people waiting for this book."
msgstr[0] "Une personne attend ce livre."
msgstr[1] "%(n)s personnes attendent ce livre."
```